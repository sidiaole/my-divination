<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易在线占卜</title>
    <style>
        /* 完全保留你 v3.0 的原始样式 */
        :root { --bg: #0d1117; --card-bg: #161b22; --accent: #58a6ff; --text: #c9d1d9; --dim: #8b949e; --highlight: #d29922; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: var(--accent); font-size: 1.4rem; border-bottom: 1px solid #30363d; padding-bottom: 15px; letter-spacing: 1px; }
        textarea { width: 100%; height: 80px; background: #000; color: #fff; border: 1px solid #30363d; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 1rem; margin-bottom: 10px; }
        .controls { display: grid; grid-template-columns: 1.5fr 1fr 0.5fr; gap: 10px; margin-bottom: 25px; }
        select, button { background: var(--card-bg); color: #fff; border: 1px solid #30363d; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        button { background: var(--accent); color: #0d1117; font-weight: bold; border: none; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .section { background: var(--card-bg); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363d; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .card-row { border-left: 4px solid var(--accent); padding-left: 15px; margin-bottom: 20px; }
        .card-name { font-size: 1.1rem; font-weight: bold; color: var(--highlight); }
        .meta-tags { font-size: 0.85rem; color: var(--dim); margin: 5px 0; font-family: monospace; }
        .analysis-text { font-size: 0.95rem; margin-top: 10px; }
        h3 { font-size: 1rem; color: var(--accent); margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 1px; }
        .synthesis { color: #aff5b4; border: 1px dashed #aff5b4; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; }
        .yao-row { font-family: monospace; font-size: 1.4rem; letter-spacing: 5px; margin: 5px 0; }
        .hidden { display: none; }
        /* 结算数值样式 */
        .energy-tag { font-size: 0.75rem; padding: 2px 6px; background: #21262d; border-radius: 3px; margin-left: 8px; border: 1px solid #30363d; }
    </style>
</head>
<body>

<h1>简易在线占卜 <small style="font-weight:normal; opacity:0.5; font-size:0.7rem;">SYSTEM LOGIC v3.5+</small></h1>

<textarea id="question" placeholder="在此输入并默念待分析的系统状态或决策描述..."></textarea>

<div class="controls">
    <select id="system" onchange="toggleUI()">
        <option value="TDM">马赛塔罗</option>
        <option value="RWS">韦特塔罗</option>
        <option value="LIUYAO">六爻起卦</option>
    </select>
    <select id="spread">
        <option value="1">单牌阵-启发 (Single)</option>
        <option value="3">三牌阵-线性推导 (Process)</option>
        <option value="5">五牌阵-结构解构 (Cross)</option>
    </select>
    <button onclick="runEngine()">执行分析...</button>
</div>

<div id="output"></div>

<script>
// --- 1. 完全保留 v3.0 常量 ---
const VERBS = { 1: "Initialization (初始化)", 2: "Branching (分化)", 3: "Expansion (扩张)", 4: "Anchoring (锚定)", 5: "Oscillation (振荡)", 6: "Calibration (校准)", 7: "Refactoring (重构)", 8: "Hardening (强化)", 9: "Satiety (充盈)", 10: "Cascade (级联)" };
const ELEMENTS = { "Wands": { name: "权杖(火)", field: "意志驱动", abstract: "原始推力、直觉执行与消耗" }, "Cups": { name: "圣杯(水)", field: "感知调节", abstract: "内部反馈、波动与渗透" }, "Swords": { name: "宝剑(风)", field: "逻辑分割", abstract: "决策冲突、定义边界与精神压力" }, "Pentacles": { name: "星币(土)", field: "物质沉淀", abstract: "产出稳固性、资源积累与现实约束" } };
const RELATIVES_MAP = { "子孙": "执行力/创意", "妻财": "产出资源/存量", "官鬼": "约束力/压强", "父母": "计划性/结构", "兄弟": "损耗因子/自我" };

// --- 新增：六爻博弈基础逻辑 ---
const FIVE_ELEMENTS_LOGIC = {
    "子孙": { element: "火", sheng: "妻财", ke: "官鬼" },
    "妻财": { element: "土", sheng: "官鬼", ke: "父母" },
    "官鬼": { element: "金", sheng: "父母", ke: "兄弟" },
    "父母": { element: "水", sheng: "兄弟", ke: "子孙" },
    "兄弟": { element: "木", sheng: "子孙", ke: "妻财" }
};

// --- 2. 完整大牌数据库 ---
const DATA = [
    { id: 0, name: "愚人", tdm: { gaze: "Right", vibe: "Warm", pacing: "Active", element: "Wands" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "纯粹的起始动力，不受既有结构约束的自由位移" },
    { id: 1, name: "魔术师", tdm: { gaze: "Right", vibe: "Warm", pacing: "Active", element: "Swords" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "资源的意识化整合，显性的创造性表达" },
    { id: 2, name: "女祭司", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Cups" }, rws: { climate: "Neutral", focus: "Individual" }, abstract: "能量的深度内敛，非公开的逻辑积蓄与静止观察" },
    { id: 3, name: "女皇", tdm: { gaze: "Right", vibe: "Warm", pacing: "Static", element: "Pentacles" }, rws: { climate: "Bright", focus: "Environment" }, abstract: "丰盈的系统增量，自然演化下的资源扩张" },
    { id: 4, name: "皇帝", tdm: { gaze: "Left", vibe: "Warm", pacing: "Static", element: "Wands" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "既有秩序的维护，高度结构化的稳定与控制" },
    { id: 5, name: "教皇", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Pentacles" }, rws: { climate: "Neutral", focus: "Interpersonal" }, abstract: "社会性契约的建立，通过共识达成的系统稳态" },
    { id: 6, name: "恋人", tdm: { gaze: "Middle", vibe: "Warm", pacing: "Active", element: "Swords" }, rws: { climate: "Bright", focus: "Interpersonal" }, abstract: "关系维度的交互，基于吸引力或选择产生的能量共振" },
    { id: 7, name: "战车", tdm: { gaze: "Middle", vibe: "Warm", pacing: "Active", element: "Wands" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "高强度的意志驱动，强制性的目标达成与位移" },
    { id: 8, name: "力量", tdm: { gaze: "Left", vibe: "Warm", pacing: "Active", element: "Wands" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "内在能量的调和，对原始冲动的柔性引导与控制" },
    { id: 9, name: "隐士", tdm: { gaze: "Left", vibe: "Cool", pacing: "Static", element: "Pentacles" }, rws: { climate: "Grey", focus: "Individual" }, abstract: "能量的回溯与剥离，寻找核心本质的缓慢进程" },
    { id: 10, name: "命运之轮", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Active", element: "Swords" }, rws: { climate: "Bright", focus: "Environment" }, abstract: "非线性周期性变动，系统级别的自动演化逻辑" },
    { id: 11, name: "正义", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Swords" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "因果律的即时判定，平衡状态的强制性纠偏" },
    { id: 12, name: "倒吊人", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Cups" }, rws: { climate: "Neutral", focus: "Individual" }, abstract: "能量的极端停滞，通过视角倒置触发的逻辑转换" },
    { id: 13, name: "死神", tdm: { gaze: "Left", vibe: "Cool", pacing: "Active", element: "Cups" }, rws: { climate: "Grey", focus: "Environment" }, abstract: "旧有结构的彻底拆解，不可逆转的能量出清" },
    { id: 14, name: "节制", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Cups" }, rws: { climate: "Bright", focus: "Individual" }, abstract: "对立能量的动态平衡，系统内部的精细调节" },
    { id: 15, name: "恶魔", tdm: { gaze: "Middle", vibe: "Warm", pacing: "Static", element: "Wands" }, rws: { climate: "Grey", focus: "Interpersonal" }, abstract: "物质层面的过度耦合，被本能或欲望束缚的能量状态" },
    { id: 16, name: "高塔", tdm: { gaze: "Middle", vibe: "Warm", pacing: "Active", element: "Wands" }, rws: { climate: "Grey", focus: "Environment" }, abstract: "僵化结构的突发性崩溃，释放被压抑能量的剧烈震荡" },
    { id: 17, name: "星星", tdm: { gaze: "Left", vibe: "Cool", pacing: "Static", element: "Cups" }, rws: { climate: "Bright", focus: "Environment" }, abstract: "压力的释放与修复，基于愿景产生的长效指引" },
    { id: 18, name: "月亮", tdm: { gaze: "Left", vibe: "Cool", pacing: "Active", element: "Cups" }, rws: { climate: "Grey", focus: "Individual" }, abstract: "潜意识的波动与幻觉，逻辑不明朗的迷雾阶段" },
    { id: 19, name: "太阳", tdm: { gaze: "Middle", vibe: "Warm", pacing: "Active", element: "Wands" }, rws: { climate: "Bright", focus: "Interpersonal" }, abstract: "能量的高度显性化，全面的清晰度与积极反馈" },
    { id: 20, name: "审判", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Active", element: "Wands" }, rws: { climate: "Bright", focus: "Interpersonal" }, abstract: "使命感的觉醒，系统层面的全面升级与重塑" },
    { id: 21, name: "世界", tdm: { gaze: "Middle", vibe: "Cool", pacing: "Static", element: "Pentacles" }, rws: { climate: "Bright", focus: "Environment" }, abstract: "逻辑闭环的达成，系统运行的圆满稳态" }
];

// --- 3. 逻辑分流函数 ---
function toggleUI() {
    const sys = document.getElementById('system').value;
    document.getElementById('spread').style.display = (sys === 'LIUYAO') ? 'none' : 'block';
}

function runEngine() {
    const sys = document.getElementById('system').value;
    const output = document.getElementById('output');
    output.innerHTML = "<p style='text-align:center;'>正在进行系统逻辑演化...</p>";

    setTimeout(() => {
        if (sys === 'LIUYAO') {
            executeLiuYao();
        } else {
            const count = parseInt(document.getElementById('spread').value);
            const deck = getFullDeck().sort(() => Math.random() - 0.5);
            const drawn = deck.slice(0, count);
            drawn.forEach(c => c.isReversed = Math.random() > 0.5);
            render(drawn, sys);
        }
    }, 500);
}

// --- 4. 完全还原 v3.0 的 getFullDeck, render 函数 ---
function getFullDeck() {
    let deck = JSON.parse(JSON.stringify(DATA));
    Object.keys(ELEMENTS).forEach(key => {
        const el = ELEMENTS[key];
        const vibe = (key === 'Wands' || key === 'Pentacles' && Math.random()>0.5) ? 'Warm' : 'Cool';
        for(let i=1; i<=10; i++) {
            deck.push({
                id: key + i, name: key + i, number: i, isMajor: false,
                tdm: { gaze: i % 2 === 0 ? "Left" : "Right", vibe: vibe, pacing: i % 3 === 0 ? "Active" : "Static", element: key },
                rws: { climate: vibe === 'Warm' ? 'Bright' : 'Grey', focus: "Individual" },
                abstract: `${el.field}领域的演化状态`
            });
        }
    });
    return deck;
}

function render(cards, sys) {
    let output = document.getElementById('output');
    output.innerHTML = "";

    let resHtml = `<div class="section"><h3>抽牌数据看板</h3>`;
    cards.forEach((c, i) => {
        const detail = sys === 'TDM' ? 
            `[ 视线: ${c.tdm.gaze} | 温感: ${c.tdm.vibe} | 领域: ${ELEMENTS[c.tdm.element].name} ]` :
            `[ 极性: ${c.isReversed ? '逆位/隐性' : '正位/显性'} | 氛围: ${c.rws.climate} | 焦点: ${c.rws.focus} ]`;
        resHtml += `<div class="card-row">
            <span class="card-name">${c.name}</span>
            <div class="meta-tags">${detail}</div>
        </div>`;
    });
    resHtml += `</div>`;

    const warmCount = cards.filter(c => c.tdm.vibe === 'Warm').length;
    const staticCount = cards.filter(c => c.tdm.pacing === 'Static').length;
    let envHtml = `<div class="section"><h3>1. 全局动力环境分析</h3>
        <p>基调: <span class="highlight">${warmCount > cards.length/2 ? '显性扩张/高熵消耗' : '内敛收缩/低熵积蓄'}</span></p>
        <p>状态: <span class="highlight">${staticCount > cards.length/2 ? '结构化稳态/强调观察' : '流动性转化/强调执行'}</span></p>
    </div>`;

    let interactHtml = "";
    if (sys === 'TDM' && cards.length > 1) {
        interactHtml = `<div class="section"><h3>2. 关键互动 (视线引擎)</h3>`;
        for(let i=0; i<cards.length-1; i++) {
            const a = cards[i], b = cards[i+1];
            let logic = "能量独立，逻辑链条处于离散状态";
            if(a.tdm.gaze === "Right" && b.tdm.gaze === "Left") logic = "【视线交汇】能量发生正面碰撞，此处为逻辑纠缠与矛盾的核心";
            if(a.tdm.gaze === "Left" && b.tdm.gaze === "Right") logic = "【背离朝向】系统存在焦点断层，两环节处于互不干涉/回避状态";
            if(a.tdm.gaze === b.tdm.gaze && a.tdm.gaze !== "Middle") logic = "【同向追随】逻辑具有连贯性，前置能量为后置环节提供持续驱动";
            interactHtml += `<p>* 节点[${a.name}] & [${b.name}]: ${logic}</p>`;
        }
        interactHtml += `</div>`;
    }

    let verdictHtml = `<div class="section"><h3>${sys === 'TDM' ? '3' : '2'}. 抽象动力学断语</h3>`;
    // 增加组合检测
    let comboMsg = "";
    if(cards.length >= 2) {
        const v1 = cards[0].number, v2 = cards[1].number;
        if(v1 === 4 && v2 === 5) comboMsg = "【判定：结构疲劳】系统在锚定稳态时遭遇强力震荡，建议检查核心协议。";
        if(v1 === 1 && v2 === 3) comboMsg = "【判定：爆发性冷启动】系统从零迅速扩张，需关注基础架构承载力。";
    }

    cards.forEach(c => {
        const verb = c.isMajor ? "原型力量介入" : VERBS[c.number];
        const polarity = (sys === 'RWS' && c.isReversed) ? "【隐性/延迟/重构】" : "【显性/驱动/执行】";
        const elementField = c.isMajor ? "跨领域" : ELEMENTS[c.tdm.element].field;
        
        verdictHtml += `<div style="margin-bottom:15px;">
            <strong>${c.name}:</strong> ${polarity} 在 ${elementField} 维度执行 <strong>${verb}</strong>。<br>
            <span class="meta-tags">> 逻辑锚点: ${c.abstract}</span>
        </div>`;
    });
    
    const synergy = (staticCount > cards.length/2 && warmCount < cards.length/2) ? "系统正处于极高效率的冷启动积蓄期，建议保持现状。" : "系统正在剧烈消耗能量以换取位移，需关注资源的可持续性。";
    if(comboMsg) verdictHtml += `<div style="color:var(--highlight); margin-top:10px; font-size:0.9rem;">${comboMsg}</div>`;
    verdictHtml += `<div class="synthesis">系统研判结论：${synergy}</div></div>`;

    output.innerHTML = resHtml + envHtml + interactHtml + verdictHtml;
}

// --- 5. 六爻逻辑层：新增能量结算系统 ---
function executeLiuYao() {
    const yaoSymbols = { "阳": "—————", "阴": "—   —", "老阳": "— O —", "老阴": "— X —" };
    let hex = [];
    const envMonth = "木"; // 固定模拟：木月
    
    // 初始化能量表
    let energyWeights = { "子孙": 10, "妻财": 10, "官鬼": 10, "父母": 10, "兄弟": 10 };
    
    // 1. 环境修正 (Buff)
    if(envMonth === "木") {
        energyWeights["兄弟"] += 5; // 木同属性
        energyWeights["子孙"] += 5; // 木生火
        energyWeights["妻财"] -= 3; // 木克土
    }

    // 2. 摇卦
    for(let i=0; i<6; i++) {
        const coins = Math.floor(Math.random()*2) + Math.floor(Math.random()*2) + Math.floor(Math.random()*2);
        let type = (coins === 3) ? "老阳" : (coins === 0) ? "老阴" : (coins === 1) ? "阳" : "阴";
        const rel = Object.keys(RELATIVES_MAP)[Math.floor(Math.random()*5)];
        const move = type.includes("老");
        
        hex.push({ type, symbol: yaoSymbols[type], rel, move });
        
        // 3. 动爻结算 (Offset)
        if(move) {
            const target = FIVE_ELEMENTS_LOGIC[rel].ke;
            energyWeights[target] -= 8; // 强效对冲
        }
    }
    renderLiuYao(hex, energyWeights);
}

function renderLiuYao(hex, weights) {
    let html = `<div class="section" style="text-align:center;"><h3>六爻卦象 (自下而上)</h3>`;
    [...hex].reverse().forEach(y => {
        html += `<div class="yao-row" style="color:${y.move?'var(--highlight)':'var(--text)'}">${y.symbol} <small>[${y.rel}]</small></div>`;
    });
    html += `</div>`;
    
    // 显性数值结算报告
    html += `<div class="section"><h3>能量权重结算报告 (数值对冲)</h3><div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">`;
    Object.keys(weights).forEach(k => {
        let val = weights[k] < 0 ? 0 : weights[k];
        let color = val > 10 ? "var(--highlight)" : val < 5 ? "#f44336" : "var(--text)";
        html += `<div class="energy-tag" style="color:${color}">${k}: ${val}</div>`;
    });
    html += `</div>`;

    const moving = hex.filter(h => h.move);
    html += `<div style="margin-top:20px;"><h3>变量博弈详情</h3>`;
    if(moving.length === 0) {
        html += `<p>系统处于<strong>静态平衡</strong>，能量权重受环境维持。建议维持现状。</p>`;
    } else {
        moving.forEach(m => {
            const target = FIVE_ELEMENTS_LOGIC[m.rel].ke;
            html += `<p>动能触发：<strong>${m.rel}</strong> 正在对冲 <strong>${target}</strong>。 
            <small style="color:var(--dim)">原因：${RELATIVES_MAP[m.rel]} 维度的位移强制修正了 ${RELATIVES_MAP[target]} 的稳态。</small></p>`;
        });
    }
    
    // 自动总结
    let summary = "";
    if(weights["官鬼"] > 12) summary = "【警告】系统压强(官鬼)过载，约束逻辑强于执行逻辑。";
    else if(weights["妻财"] < 5) summary = "【风险】资源存量(妻财)被对冲严重，处于负向损耗状态。";
    else if(weights["子孙"] > 12) summary = "【利好】执行力(子孙)获得爆发性环境加成，压强已被有效对冲。";
    else summary = "系统当前的对冲点在于内部变量的能量结算余量。";

    html += `<div class="synthesis">博弈总结：${summary}</div></div>`;
    document.getElementById('output').innerHTML = html;
}
</script>
</body>
</html>
